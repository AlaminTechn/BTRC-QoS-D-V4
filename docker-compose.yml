###############################################################################
# BTRC QoS Dashboard v4
# Stack: TimescaleDB · Metabase · Martin (PMTiles) · React-Leaflet Frontend
#
# Usage:
#   bash scripts/start.sh          ← recommended (stops old, loads data, starts all)
#   docker compose up -d           ← bare minimum (no data loading)
###############################################################################

services:

  # ── 1. TimescaleDB + PostGIS ─────────────────────────────────────────────
  timescaledb:
    image: timescale/timescaledb-ha:pg15-latest
    container_name: btrc-v4-timescaledb
    restart: unless-stopped
    environment:
      POSTGRES_USER:     ${DB_USER:-btrc_admin}
      POSTGRES_PASSWORD: ${DB_PASSWORD:-btrc_poc_2026}
      POSTGRES_DB:       ${DB_NAME:-btrc_qos_poc}
      TIMESCALEDB_TELEMETRY: "off"
    ports:
      - "${DB_PORT:-5433}:5432"
    volumes:
      - timescale_data:/home/postgres/pgdata/data
      # 00-create-db.sh runs first (shell, so CREATE DATABASE works outside a transaction)
      - ./docker/init/00-create-db.sh:/docker-entrypoint-initdb.d/00-create-db.sh:ro
      # 01-extensions.sql runs second (enables timescaledb/postgis/pg_trgm in btrc_qos_poc)
      - ./docker/init/01-extensions.sql:/docker-entrypoint-initdb.d/01-extensions.sql:ro
    networks:
      - btrc-v4
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USER:-btrc_admin} -d ${DB_NAME:-btrc_qos_poc}"]
      interval: 10s
      timeout: 5s
      retries: 10

  # ── 2. Metabase ──────────────────────────────────────────────────────────
  metabase:
    image: metabase/metabase:latest
    container_name: btrc-v4-metabase
    restart: unless-stopped
    depends_on:
      timescaledb:
        condition: service_healthy
    environment:
      # Metabase metadata DB (separate from btrc_qos_poc)
      MB_DB_TYPE:   postgres
      MB_DB_HOST:   timescaledb
      MB_DB_PORT:   5432
      MB_DB_USER:   ${DB_USER:-btrc_admin}
      MB_DB_PASS:   ${DB_PASSWORD:-btrc_poc_2026}
      MB_DB_DBNAME: metabase_app
      # Site config
      MB_SITE_URL:  ${METABASE_SITE_URL:-http://localhost:3000}
      MB_EMBEDDING_APP_ORIGINS: "http://localhost:5173 http://localhost:3000"
      JAVA_TIMEZONE: Asia/Dhaka
      MB_ANON_TRACKING_ENABLED: "false"
      # Expose admin creds so setup_metabase.py can use them via env
      METABASE_ADMIN_EMAIL:    ${METABASE_USER:-alamin.technometrics22@gmail.com}
      METABASE_ADMIN_PASSWORD: ${METABASE_PASS:-Test@123}
    ports:
      - "3000:3000"
    volumes:
      - metabase_data:/metabase-data
    networks:
      - btrc-v4
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:3000/api/health | grep -q ok || exit 1"]
      interval: 20s
      timeout: 10s
      retries: 15
      start_period: 90s

  # ── 3. Martin — PMTiles tile server (offline tiles) ──────────────────────
  # Scans /tiles directory — starts fine even when empty (no crash on missing file).
  # Tile URL (after downloading): http://localhost:3001/tiles/bangladesh/{z}/{x}/{y}
  # Download tiles first: bash scripts/download-tiles.sh
  martin:
    image: ghcr.io/maplibre/martin:latest
    container_name: btrc-v4-martin
    restart: unless-stopped
    ports:
      - "3001:3000"
    volumes:
      - ./tiles:/tiles:ro
      - ./docker/martin-config.yaml:/config.yaml:ro
    command: ["--config", "/config.yaml"]
    networks:
      - btrc-v4
    healthcheck:
      # Martin image has no wget/curl; use /proc/net/tcp to check port 3000 is listening (hex 0BB8 = 3000)
      test: ["CMD-SHELL", "cat /proc/net/tcp | grep -q '00000000:0BB8' || exit 1"]
      interval: 15s
      timeout: 5s
      retries: 5
      start_period: 10s

  # ── 4. React + Leaflet Frontend (Vite dev server) ────────────────────────
  frontend:
    build:
      context: ./btrc-frontend
      dockerfile: ../docker/Dockerfile.frontend
      target: dev
    container_name: btrc-v4-frontend
    restart: unless-stopped
    depends_on:
      - metabase
      - martin
    environment:
      # ── Server-side proxy targets (container names, no VITE_ prefix) ──────
      # vite.config.js reads these via process.env to route /api and /tiles
      # requests to the correct containers on the Docker network.
      METABASE_PROXY_TARGET: http://metabase:3000
      TILE_PROXY_TARGET:     http://martin:3000

      # ── Browser-side env (bundled into the JS by Vite) ───────────────────
      # Empty string → axios uses relative paths → /api/... goes through Vite proxy.
      VITE_METABASE_URL:  ""
      # Relative tile URL → goes through Vite /tiles proxy → martin container.
      VITE_TILE_URL:      "/tiles/bangladesh/{z}/{x}/{y}"
      # Credentials for auto-login
      VITE_METABASE_USER: ${METABASE_USER:-alamin.technometrics22@gmail.com}
      VITE_METABASE_PASS: ${METABASE_PASS:-Test@123}
    ports:
      - "5173:5173"
    volumes:
      - ./btrc-frontend:/app
      - /app/node_modules
      - ./geodata:/app/public/geodata:ro
    networks:
      - btrc-v4

networks:
  btrc-v4:
    driver: bridge

volumes:
  timescale_data:
  metabase_data:
